<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioGuard Pro v5.0 | Anti-Spoofing Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root {
            --p-blue: #020617;
            --s-blue: #1e293b;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --background: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --radius-lg: 16px;
            --radius-md: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body { font-family: 'Inter', sans-serif; background: var(--background); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar & Layout */
        aside { width: 280px; background: var(--p-blue); color: white; padding: 32px 24px; display: flex; flex-direction: column; }
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 80px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; }

        .brand-logo { width: 40px; height: 40px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-family: 'Plus Jakarta Sans'; margin-bottom: 40px; }
        
        .nav-link { padding: 14px 16px; color: #94a3b8; text-decoration: none; border-radius: var(--radius-md); margin-bottom: 8px; font-size: 14px; cursor: pointer; border: none; background: transparent; width: 100%; text-align: left; display: flex; align-items: center; gap: 12px; }
        .nav-link.active { background: var(--accent); color: white; }

        .content-scroll { flex: 1; padding: 40px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }

        /* Liveness UI Elements */
        .camera-wrapper { position: relative; background: #000; border-radius: 24px; overflow: hidden; aspect-ratio: 16/9; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 4px solid white; }
        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }

        .liveness-overlay {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }

        .liveness-badge {
            padding: 8px 16px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1px; backdrop-filter: blur(10px); color: white;
            display: flex; align-items: center; gap: 8px;
        }
        .status-scanning { background: rgba(59, 130, 246, 0.5); border: 1px solid rgba(59, 130, 246, 0.5); }
        .status-alert { background: rgba(239, 68, 68, 0.5); border: 1px solid rgba(239, 68, 68, 0.5); }

        .challenge-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px);
            padding: 16px 32px; border-radius: 40px; color: white; text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2); z-index: 10; min-width: 300px;
        }

        .blink-indicator { width: 12px; height: 12px; border-radius: 50%; background: #94a3b8; transition: 0.2s; }
        .blink-active { background: var(--success); box-shadow: 0 0 15px var(--success); }

        /* Stats & Logs */
        .grid-main { display: grid; grid-template-columns: 1.5fr 1fr; gap: 32px; }
        .monitor-card { background: white; border-radius: var(--radius-lg); border: 1px solid var(--border); padding: 24px; }
        #log-stream { height: 300px; overflow-y: auto; margin-top: 16px; font-size: 13px; }
        .log-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }

        /* Buttons */
        .btn { padding: 12px 24px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; border: none; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        
        #system-loader { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .spoof-detected { animation: shake 0.5s; border-color: var(--danger) !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

    <div id="system-loader">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: var(--text-muted); font-size: 14px;">Mengaktifkan Liveness Engine...</p>
    </div>

    <aside>
        <div class="brand-logo">B</div>
        <button class="nav-link active" onclick="navigate('dashboard', this)"><span>ðŸ“·</span> Absensi Live</button>
        <button class="nav-link" onclick="navigate('database', this)"><span>ðŸ‘¥</span> Data Personil</button>
        <button class="nav-link" onclick="navigate('history', this)"><span>ðŸ“Š</span> Log Keamanan</button>
        
        <div style="margin-top: auto; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; font-size: 11px;">
            <p style="color: #94a3b8; margin-bottom: 4px;">ANTI-SPOOFING</p>
            <p style="font-weight: 700; color: var(--success);">Blink Detection Active</p>
        </div>
    </aside>

    <main>
        <header>
            <div>
                <h2 id="page-title">Absensi Live</h2>
                <p id="clock" style="font-size: 13px; color: var(--text-muted);"></p>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="text-align: right;"><p style="font-size: 14px; font-weight: 600;">Admin Keamanan</p></div>
                <div style="width: 36px; height: 36px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">A</div>
            </div>
        </header>

        <div class="content-scroll">
            <!-- PAGE: DASHBOARD -->
            <section id="dashboard" class="page active">
                <div class="grid-main">
                    <div class="camera-wrapper" id="camera-box">
                        <div class="liveness-overlay">
                            <div id="liveness-badge" class="liveness-badge status-scanning">
                                <span class="blink-indicator" id="blink-dot"></span>
                                AI Eye-Tracking Aktif
                            </div>
                            <div class="liveness-badge status-scanning" id="face-count">0 Face Detected</div>
                        </div>

                        <div class="challenge-box" id="challenge-ui">
                            <p id="challenge-text" style="font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px;">Inisialisasi...</p>
                            <h3 id="challenge-instruction" style="font-size: 18px; margin-top: 4px;">Harap hadap ke depan</h3>
                        </div>

                        <video id="video" autoplay muted playsinline></video>
                        <canvas id="canvas"></canvas>
                    </div>

                    <div class="monitor-card">
                        <h4 style="font-size: 15px; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 12px;">Log Verifikasi Real-time</h4>
                        <div id="log-stream">
                            <p style="color: var(--text-muted); text-align: center; margin-top: 30px;">Siap memindai...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PAGE: DATABASE -->
            <section id="database" class="page">
                <div style="background: white; padding: 24px; border-radius: var(--radius-lg); border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 24px;">Pendaftaran Biometric Baru</h3>
                    <div style="display: flex; gap: 32px;">
                        <div style="width: 150px; height: 150px; background: #f1f5f9; border-radius: 20px; overflow: hidden;">
                            <img id="reg-preview" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <div id="reg-placeholder" style="display:flex; height:100%; align-items:center; justify-content:center; color: #94a3b8;" onclick="document.getElementById('file-input').click()">ðŸ“¸</div>
                        </div>
                        <div style="flex: 1;">
                            <input type="file" id="file-input" hidden onchange="previewFile(event)">
                            <input type="text" id="reg-name" placeholder="Nama Lengkap" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px;">
                            <button class="btn btn-primary" onclick="registerUser()">Simpan Biometric</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PAGE: HISTORY -->
            <section id="history" class="page">
                <div style="background: white; border-radius: var(--radius-lg); border: 1px solid var(--border); overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f8fafc;">
                            <tr>
                                <th style="padding: 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Waktu</th>
                                <th style="padding: 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Nama</th>
                                <th style="padding: 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Status Liveness</th>
                                <th style="padding: 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Metode</th>
                            </tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <script>
        // --- KONFIGURASI LIVENESS ---
        let personnel = JSON.parse(localStorage.getItem('bioguard_users')) || [];
        let logs = JSON.parse(localStorage.getItem('bioguard_logs')) || [];
        let faceMatcher = null;
        let isProcessing = false;

        // Threshold Kedipan (Eye Aspect Ratio / EAR)
        const BLINK_THRESHOLD = 0.22;
        let blinkCounter = 0;
        let hasBlinked = false;
        let livenessScore = 0;

        async function init() {
            updateClock();
            setInterval(updateClock, 1000);

            try {
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);

                updateMatcher();
                document.getElementById('system-loader').style.display = 'none';
                startCamera();
            } catch (err) {
                alert("Gagal memuat AI Engine.");
            }
        }

        function updateClock() {
            document.getElementById('clock').innerText = new Date().toLocaleString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        async function startCamera() {
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                video.srcObject = stream;
                
                video.onplay = () => {
                    const canvas = document.getElementById('canvas');
                    const displaySize = { width: video.clientWidth, height: video.clientHeight };
                    faceapi.matchDimensions(canvas, displaySize);

                    setInterval(async () => {
                        if (isProcessing) return;

                        const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                        const resized = faceapi.resizeResults(detections, displaySize);
                        
                        document.getElementById('face-count').innerText = `${detections.length} Face Detected`;

                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);

                        if (resized.length > 0) {
                            const det = resized[0];
                            const landmarks = det.landmarks;
                            
                            // 1. BLINK DETECTION (Anti-Foto)
                            checkLiveness(landmarks);

                            // 2. FACE MATCHING
                            if (personnel.length > 0 && faceMatcher) {
                                const match = faceMatcher.findBestMatch(det.descriptor);
                                
                                // Box styling
                                ctx.strokeStyle = match.label === 'unknown' ? '#ef4444' : (hasBlinked ? '#10b981' : '#3b82f6');
                                ctx.lineWidth = 4;
                                ctx.strokeRect(det.detection.box.x, det.detection.box.y, det.detection.box.width, det.detection.box.height);

                                if (match.label !== 'unknown' && match.distance < 0.45) {
                                    handleChallenge(match.label);
                                } else {
                                    resetChallenge("Mencari data personil...");
                                }
                            } else {
                                resetChallenge("Database Kosong");
                            }
                        } else {
                            resetChallenge("Harap hadap ke kamera");
                            hasBlinked = false;
                            blinkCounter = 0;
                            document.getElementById('blink-dot').classList.remove('blink-active');
                        }
                    }, 100);
                };
            } catch (e) {
                alert("Kamera tidak aktif.");
            }
        }

        // Hitung Eye Aspect Ratio (EAR) untuk deteksi kedipan
        function checkLiveness(landmarks) {
            const leftEye = landmarks.getLeftEye();
            const rightEye = landmarks.getRightEye();

            const earL = getEAR(leftEye);
            const earR = getEAR(rightEye);
            const avgEAR = (earL + earR) / 2;

            if (avgEAR < BLINK_THRESHOLD) {
                blinkCounter++;
                document.getElementById('blink-dot').classList.add('blink-active');
            } else {
                if (blinkCounter >= 2) { // Minimal tertutup selama 2 frame
                    hasBlinked = true;
                    pushLog("Kedipan terdeteksi (Liveness Valid)");
                }
                blinkCounter = 0;
                document.getElementById('blink-dot').classList.remove('blink-active');
            }
        }

        function getEAR(eye) {
            const p2p6 = Math.sqrt(Math.pow(eye[1].x - eye[5].x, 2) + Math.pow(eye[1].y - eye[5].y, 2));
            const p3p5 = Math.sqrt(Math.pow(eye[2].x - eye[4].x, 2) + Math.pow(eye[2].y - eye[4].y, 2));
            const p1p4 = Math.sqrt(Math.pow(eye[0].x - eye[3].x, 2) + Math.pow(eye[0].y - eye[3].y, 2));
            return (p2p6 + p3p5) / (2.0 * p1p4);
        }

        function handleChallenge(name) {
            const text = document.getElementById('challenge-text');
            const inst = document.getElementById('challenge-instruction');

            if (!hasBlinked) {
                text.innerText = `Halo, ${name.split(' ')[0]}`;
                inst.innerText = "Silahkan berkedip sekali";
                inst.style.color = "white";
            } else {
                inst.innerText = "Liveness OK. Berhasil!";
                inst.style.color = "#10b981";
                processAttendance(name);
            }
        }

        function resetChallenge(msg) {
            document.getElementById('challenge-text').innerText = "Security Scanning";
            document.getElementById('challenge-instruction').innerText = msg;
            document.getElementById('challenge-instruction').style.color = "white";
        }

        async function processAttendance(name) {
            if (isProcessing) return;
            
            // Cek cooldown (anti double log)
            const lastLog = logs.find(l => l.name === name);
            if (lastLog) {
                const diff = (new Date() - new Date(lastLog.fullDate)) / 1000 / 60;
                if (diff < 1) return;
            }

            isProcessing = true;
            const now = new Date();
            const logEntry = {
                name: name,
                time: now.toLocaleTimeString('id-ID'),
                date: now.toLocaleDateString('id-ID'),
                status: 'PASSED',
                method: 'Blink Detection',
                fullDate: now.toISOString()
            };

            logs.unshift(logEntry);
            localStorage.setItem('bioguard_logs', JSON.stringify(logs));
            
            pushLog(`âœ… Absensi Berhasil: ${name}`);
            renderHistory();
            
            // Animasi transisi setelah sukses
            setTimeout(() => {
                hasBlinked = false;
                isProcessing = false;
            }, 3000);
        }

        // --- UI & DATABASE ---
        function updateMatcher() {
            if (personnel.length === 0) return;
            const labeled = personnel.map(u => new faceapi.LabeledFaceDescriptors(u.name, [new Float32Array(u.descriptor)]));
            faceMatcher = new faceapi.FaceMatcher(labeled, 0.45);
        }

        function previewFile(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.getElementById('reg-preview');
                    img.src = ev.target.result;
                    img.style.display = 'block';
                    document.getElementById('reg-placeholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        async function registerUser() {
            const name = document.getElementById('reg-name').value;
            const img = document.getElementById('reg-preview');
            if (!name || !img.src) return alert("Data tidak lengkap");

            try {
                const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                if (det) {
                    personnel.push({
                        name: name,
                        descriptor: Array.from(det.descriptor),
                        id: Date.now()
                    });
                    localStorage.setItem('bioguard_users', JSON.stringify(personnel));
                    alert("Registrasi Berhasil");
                    updateMatcher();
                } else {
                    alert("Wajah tidak terdeteksi pada foto.");
                }
            } catch (e) { alert("Error sistem."); }
        }

        function pushLog(msg) {
            const stream = document.getElementById('log-stream');
            if (stream.innerHTML.includes("Siap memindai")) stream.innerHTML = "";
            const item = document.createElement('div');
            item.className = 'log-item';
            item.innerHTML = `<span>${msg}</span> <span style="color:var(--text-muted)">${new Date().toLocaleTimeString()}</span>`;
            stream.prepend(item);
        }

        function navigate(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if (id === 'history') renderHistory();
        }

        function renderHistory() {
            const body = document.getElementById('history-body');
            body.innerHTML = logs.map(l => `
                <tr>
                    <td style="padding:16px;">${l.time}</td>
                    <td style="padding:16px; font-weight:600;">${l.name}</td>
                    <td style="padding:16px;"><span style="color:var(--success); font-weight:700;">${l.status}</span></td>
                    <td style="padding:16px; color:var(--text-muted); font-size:12px;">${l.method}</td>
                </tr>
            `).join('');
        }

        window.onload = init;
    </script>
</body>
</html>

